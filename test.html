<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robust Media Session Priority Hack</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        /* The hack audio element is intentionally hidden */
        #priority-audio {
            display: none;
        }
    </style>
</head>
<body>

    <h1>Your Custom Media Player</h1>
    <button id="playPauseButton">Play Custom Audio</button>
    <p>Status: <span id="status">Paused</span></p>

    <audio id="priority-audio" src="5-seconds-of-silence.mp3" preload="auto"></audio>

    <hr>

    <h2>YouTube Embedded Video (Will be forced to stop)</h2>
    <iframe id="youtube-player" width="560" height="315" 
        src="https://www.youtube.com/embed/Bfc3HXQqoaM?enablejsapi=1" 
        title="YouTube video player" 
        frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
        referrerpolicy="strict-origin-when-cross-origin" 
        allowfullscreen>
    </iframe>
    
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- Global State and Elements ---
        let isCustomMediaPlaying = false;
        const statusElement = document.getElementById('status');
        const playPauseButton = document.getElementById('playPauseButton');
        const dummyAudio = document.getElementById('priority-audio');
        let youtubePlayer; // Variable to hold the YouTube API object

        // --- YouTube API Initialization (Mandatory function name) ---

        /**
         * The YouTube API calls this function when it is loaded.
         * We initialize the player object here.
         */
        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('youtube-player', {
                events: {
                    // You can add 'onStateChange' listeners here if you need to react 
                    // when the YouTube video starts or stops playing.
                    // E.g., if YouTube plays, you might want to pause your custom audio.
                }
            });
            console.log("YouTube Player API ready.");
        }


        // --- Core Helper Functions ---

        /**
         * Updates the custom player's state and UI.
         * @param {boolean} isPlaying 
         */
        function toggleCustomMedia(isPlaying) {
            isCustomMediaPlaying = isPlaying;
            statusElement.textContent = isPlaying ? 'Playing Custom Audio' : 'Paused';
            playPauseButton.textContent = isPlaying ? 'Pause Custom Audio' : 'Play Custom Audio';
            
            updateMediaSession();
        }

        /**
         * The combined priority logic: Stop YouTube, then force focus with silent audio.
         */
        function reclaimMediaSessionPriority() {
            console.log("Attempting to reclaim media session priority...");
            
            // 1. FORCE YOUTUBE TO STOP (Most critical step for reliable priority)
            if (youtubePlayer && typeof youtubePlayer.stopVideo === 'function') {
                // stopVideo() ensures the iFrame's Media Session is terminated.
                youtubePlayer.stopVideo(); 
                console.log("YouTube video forcefully stopped.");
            }

            // 2. FORCE MAIN DOCUMENT FOCUS (The original "hack")
            dummyAudio.play()
                .then(() => {
                    dummyAudio.pause();
                    console.log("Silent audio sequence completed.");
                    updateMediaSession();
                })
                .catch(error => {
                    console.warn("Failed to complete silent audio sequence (likely blocked by browser due to no user gesture).", error);
                    updateMediaSession();
                });
        }


        // --- Media Session API Implementation ---

        /**
         * Sets up the Media Session handlers and metadata for your custom player.
         */
        function updateMediaSession() {
            if (!('mediaSession' in navigator)) {
                 console.warn("Media Session API not supported in this browser.");
                 return;
            }
            
            // 1. Set Metadata (Appears on the lock screen/notification)
            navigator.mediaSession.metadata = new MediaMetadata({
                title: 'My Custom Web Player Track',
                artist: 'The Priority App',
                album: 'Web Hack Collection',
                artwork: [
                    { src: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjZjAwIiBkPSJtMTAuMjc1IDE2bDUuNTc1LTMuNTc1cS4yMjUtLjE1LjIyNS0uNDI1dC0uMjI1LS40MjVMMTAuMjc1IDhxLS4yNS0uMTc1LS41MTMtLjAyNXQtLjI2Mi40NXY3LjE1cTAgLjMuMjYzLjQ1dC41MTItLjAyNU00IDIwcS0uODI1IDAtMS40MTItLjU4N1QyIDE4VjZxMC0uODI1LjU4OC0xLjQxMlQ0IDRoMTZxLjgyNSAwIDEuNDEzLjU4OFQyMiA2djEycTAgLjgyNS0uNTg3IDEuNDEzVDIwIDIweiIvPjwvc3ZnPg==', type: 'image/svg' },
                ]
            });

            // 2. Set Action Handlers (What happens when a system button is pressed)
            
            navigator.mediaSession.setActionHandler('play', () => {
                console.log('Media Session: Play pressed (via system)');
                reclaimMediaSessionPriority(); 
                toggleCustomMedia(true);
            });

            navigator.mediaSession.setActionHandler('pause', () => {
                console.log('Media Session: Pause pressed (via system)');
                toggleCustomMedia(false);
                // Reclaim priority one last time to leave the 'paused' session visible
                reclaimMediaSessionPriority(); 
            });

            // 3. Update the Playback State 
            navigator.mediaSession.playbackState = isCustomMediaPlaying ? "playing" : "paused";
        }


        // --- Event Listener ---

        // Button click handler
        playPauseButton.addEventListener('click', () => {
            const newState = !isCustomMediaPlaying;
            
            // A user click is the best time to run the priority hack
            reclaimMediaSessionPriority(); 

            // Apply the state change
            toggleCustomMedia(newState);
        });

        // 4. Initial call to set up the Media Session when the page loads
        document.addEventListener('DOMContentLoaded', updateMediaSession); 
    </script>

</body>
</html>